//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: tripleplay/flump/Movie.java
//
//  Created by Thomas on 7/1/13.
//

#import "IOSObjectArray.h"
#import "java/lang/Math.h"
#import "java/util/ArrayList.h"
#import "java/util/Arrays.h"
#import "java/util/Collections.h"
#import "java/util/HashMap.h"
#import "java/util/Iterator.h"
#import "java/util/List.h"
#import "java/util/Map.h"
#import "playn/core/Asserts.h"
#import "playn/core/Graphics.h"
#import "playn/core/GroupLayer.h"
#import "playn/core/Json.h"
#import "playn/core/Layer.h"
#import "playn/core/PlayN.h"
#import "playn/core/util/Clock.h"
#import "pythagoras/f/FloatMath.h"
#import "pythagoras/f/IPoint.h"
#import "pythagoras/f/Transform.h"
#import "tripleplay/flump/Instance.h"
#import "tripleplay/flump/KeyframeData.h"
#import "tripleplay/flump/LayerData.h"
#import "tripleplay/flump/Library.h"
#import "tripleplay/flump/Symbol.h"

@implementation TripleplayFlumpMovie

- (TripleplayFlumpMovie_Symbol *)_symbol {
  return _symbol_;
}
- (void)set_symbol:(TripleplayFlumpMovie_Symbol *)_symbol {
  JreOperatorRetainedAssign(&_symbol_, self, _symbol);
}
@synthesize _symbol = _symbol_;
- (id<PlaynCoreGroupLayer>)_root {
  return _root_;
}
- (void)set_root:(id<PlaynCoreGroupLayer>)_root {
  JreOperatorRetainedAssign(&_root_, self, _root);
}
@synthesize _root = _root_;
- (IOSObjectArray *)_animators {
  return _animators_;
}
- (void)set_animators:(IOSObjectArray *)_animators {
  JreOperatorRetainedAssign(&_animators_, self, _animators);
}
@synthesize _animators = _animators_;
@synthesize _frame = _frame_;
@synthesize _position = _position_;
@synthesize _speed = _speed_;

- (id)initWithTripleplayFlumpMovie_Symbol:(TripleplayFlumpMovie_Symbol *)symbol {
  if ((self = [super init])) {
    JreOperatorRetainedAssign(&_root_, self, [((id<PlaynCoreGraphics>) [PlaynCorePlayN graphics]) createGroupLayer]);
    _frame_ = 0;
    _position_ = 0;
    _speed_ = 1;
    JreOperatorRetainedAssign(&_symbol_, self, symbol);
    JreOperatorRetainedAssign(&_animators_, self, [[[IOSObjectArray alloc] initWithLength:[((id<JavaUtilList>) NIL_CHK(symbol.layers)) size] type:[IOSClass classWithClass:[TripleplayFlumpMovie_LayerAnimator class]]] autorelease]);
    for (int ii = 0, ll = (int) [((IOSObjectArray *) NIL_CHK(_animators_)) count]; ii < ll; ++ii) {
      TripleplayFlumpMovie_LayerAnimator *animator = [[[TripleplayFlumpMovie_LayerAnimator alloc] initWithTripleplayFlumpLayerData:((TripleplayFlumpLayerData *) [((id<JavaUtilList>) NIL_CHK(symbol.layers)) getWithInt:ii])] autorelease];
      [((IOSObjectArray *) NIL_CHK(_animators_)) replaceObjectAtIndex:ii withObject:animator];
      [((id<PlaynCoreGroupLayer>) NIL_CHK(_root_)) addWithPlaynCoreLayer:((TripleplayFlumpMovie_LayerAnimator *) NIL_CHK(animator)).content];
    }
    [self setFrameWithFloat:1 withFloat:0];
  }
  return self;
}

- (id<PlaynCoreGroupLayer>)layer {
  return _root_;
}

- (void)paintWithPlaynCoreUtilClock:(id<PlaynCoreUtilClock>)clock {
  [self paintWithFloat:[((id<PlaynCoreUtilClock>) NIL_CHK(clock)) dt]];
}

- (void)paintWithFloat:(float)dt {
  dt *= _speed_;
  _position_ += dt;
  if (_position_ > ((TripleplayFlumpMovie_Symbol *) NIL_CHK(_symbol_)).duration) {
    _position_ = fmodf(_position_, ((TripleplayFlumpMovie_Symbol *) NIL_CHK(_symbol_)).duration);
  }
  float nextFrame = _position_ * ((TripleplayFlumpMovie_Symbol *) NIL_CHK(_symbol_))._framesPerMs;
  [self setFrameWithFloat:nextFrame withFloat:dt];
}

- (float)position {
  return _position_;
}

- (void)setPositionWithFloat:(float)position {
  if (position < 0) position = 0;
  _position_ = position;
  [self paintWithFloat:0];
}

- (TripleplayFlumpMovie_Symbol *)symbol {
  return _symbol_;
}

- (float)speed {
  return _speed_;
}

- (void)setSpeedWithFloat:(float)speed {
  _speed_ = speed;
}

- (id<PlaynCoreLayer>)getNamedLayerWithNSString:(NSString *)name {
  TripleplayFlumpMovie_LayerAnimator *animator = [self getNamedAnimatorWithNSString:name];
  return animator != nil ? ((TripleplayFlumpMovie_LayerAnimator *) NIL_CHK(animator)).content : nil;
}

- (id<JavaUtilList>)getInstancesWithNSString:(NSString *)name {
  TripleplayFlumpMovie_LayerAnimator *animator = [self getNamedAnimatorWithNSString:name];
  if (animator == nil) return ((id<JavaUtilList>) [JavaUtilCollections emptyList]);
  if (((TripleplayFlumpMovie_LayerAnimator *) NIL_CHK(animator))._instances == nil) return ((id<JavaUtilList>) [JavaUtilCollections singletonListWithId:((TripleplayFlumpMovie_LayerAnimator *) NIL_CHK(animator))._current]);
  return ((id<JavaUtilList>) [JavaUtilCollections unmodifiableListWithJavaUtilList:((id<JavaUtilList>) [JavaUtilArrays asListWithNSObjectArray:((TripleplayFlumpMovie_LayerAnimator *) NIL_CHK(animator))._instances])]);
}

- (void)setNamedLayerWithNSString:(NSString *)name
      withTripleplayFlumpInstance:(id<TripleplayFlumpInstance>)instance {
  TripleplayFlumpMovie_LayerAnimator *animator = [self getNamedAnimatorWithNSString:name];
  if (animator != nil) {
    [PlaynCoreAsserts checkStateWithBOOL:[(id) animator.content conformsToProtocol: @protocol(PlaynCoreGroupLayer)] withNSString:@"Layer not a container" withNSObjectArray:[IOSObjectArray arrayWithType:[IOSClass classWithClass:[NSObject class]] count:2, @"name", name ]];
    [animator setCurrentWithTripleplayFlumpInstance:instance];
  }
}

- (id<JavaUtilMap>)namedLayers {
  id<JavaUtilMap> namedLayers = [[[JavaUtilHashMap alloc] init] autorelease];
  {
    IOSObjectArray *a__ = _animators_;
    int n__ = (int) [((IOSObjectArray *) NIL_CHK(a__)) count];
    for (int i__ = 0; i__ < n__; i__++) {
      TripleplayFlumpMovie_LayerAnimator *animator = ((TripleplayFlumpMovie_LayerAnimator *) [((IOSObjectArray *) NIL_CHK(a__)) objectAtIndex:i__]);
      (void) [((id<JavaUtilMap>) NIL_CHK(namedLayers)) putWithId:((TripleplayFlumpLayerData *) NIL_CHK(animator.data)).name withId:((TripleplayFlumpMovie_LayerAnimator *) NIL_CHK(animator)).content];
    }
  }
  return ((id<JavaUtilMap>) [JavaUtilCollections unmodifiableMapWithJavaUtilMap:namedLayers]);
}

- (TripleplayFlumpMovie_LayerAnimator *)getNamedAnimatorWithNSString:(NSString *)name {
  {
    IOSObjectArray *a__ = _animators_;
    int n__ = (int) [((IOSObjectArray *) NIL_CHK(a__)) count];
    for (int i__ = 0; i__ < n__; i__++) {
      TripleplayFlumpMovie_LayerAnimator *animator = ((TripleplayFlumpMovie_LayerAnimator *) [((IOSObjectArray *) NIL_CHK(a__)) objectAtIndex:i__]);
      if ([NIL_CHK(animator.data.name) isEqual:name]) {
        return animator;
      }
    }
  }
  return nil;
}

- (void)setFrameWithFloat:(float)frame
                withFloat:(float)dt {
  if (frame < _frame_) {
    for (int ii = 0, ll = (int) [((IOSObjectArray *) NIL_CHK(_animators_)) count]; ii < ll; ++ii) {
      TripleplayFlumpMovie_LayerAnimator *animator = ((TripleplayFlumpMovie_LayerAnimator *) [((IOSObjectArray *) NIL_CHK(_animators_)) objectAtIndex:ii]);
      ((TripleplayFlumpMovie_LayerAnimator *) NIL_CHK(animator)).changedKeyframe = YES;
      ((TripleplayFlumpMovie_LayerAnimator *) NIL_CHK(animator)).keyframeIdx = 0;
    }
  }
  for (int ii = 0, ll = (int) [((IOSObjectArray *) NIL_CHK(_animators_)) count]; ii < ll; ++ii) {
    TripleplayFlumpMovie_LayerAnimator *animator = ((TripleplayFlumpMovie_LayerAnimator *) [((IOSObjectArray *) NIL_CHK(_animators_)) objectAtIndex:ii]);
    [((TripleplayFlumpMovie_LayerAnimator *) NIL_CHK(animator)) setFrameWithFloat:frame withFloat:dt];
  }
  _frame_ = frame;
}

- (void)dealloc {
  JreOperatorRetainedAssign(&_animators_, self, nil);
  JreOperatorRetainedAssign(&_root_, self, nil);
  JreOperatorRetainedAssign(&_symbol_, self, nil);
  [super dealloc];
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayFlumpMovie *typedCopy = (TripleplayFlumpMovie *) copy;
  typedCopy._symbol = _symbol_;
  typedCopy._root = _root_;
  typedCopy._animators = _animators_;
  typedCopy._frame = _frame_;
  typedCopy._position = _position_;
  typedCopy._speed = _speed_;
}

@end
@implementation TripleplayFlumpMovie_Symbol

@synthesize frames = frames_;
- (id<JavaUtilList>)layers {
  return layers_;
}
- (void)setLayers:(id<JavaUtilList>)layers {
  JreOperatorRetainedAssign(&layers_, self, layers);
}
@synthesize layers = layers_;
@synthesize duration = duration_;
- (NSString *)_name {
  return _name_;
}
- (void)set_name:(NSString *)_name {
  JreOperatorRetainedAssign(&_name_, self, _name);
}
@synthesize _name = _name_;
@synthesize _framesPerMs = _framesPerMs_;

- (id)initWithTripleplayFlumpLibrary:(TripleplayFlumpLibrary *)lib
            withPlaynCoreJson_Object:(id<PlaynCoreJson_Object>)json {
  if ((self = [super init])) {
    JreOperatorRetainedAssign(&_name_, self, [((id<PlaynCoreJson_Object>) NIL_CHK(json)) getStringWithNSString:@"id"]);
    JavaUtilArrayList *layers = [[[JavaUtilArrayList alloc] init] autorelease];
    self.layers = ((id<JavaUtilList>) [JavaUtilCollections unmodifiableListWithJavaUtilList:layers]);
    int frames = 0;
    {
      id<JavaUtilIterator> iter__ = ((id<JavaUtilIterator>) [((id<PlaynCoreJson_TypedArray>) [((id<PlaynCoreJson_Object>) NIL_CHK(json)) getArrayWithNSString:@"layers" withIOSClass:[IOSClass classWithProtocol:@protocol(PlaynCoreJson_Object)]]) iterator]);
      while ([((id<JavaUtilIterator>) NIL_CHK(iter__)) hasNext]) {
        id<PlaynCoreJson_Object> layerJson = ((id<PlaynCoreJson_Object>) [((id<JavaUtilIterator>) NIL_CHK(iter__)) next]);
        TripleplayFlumpLayerData *layer = [[[TripleplayFlumpLayerData alloc] initWithPlaynCoreJson_Object:layerJson] autorelease];
        frames = [JavaLangMath maxWithInt:[((TripleplayFlumpLayerData *) NIL_CHK(layer)) frames] withInt:frames];
        [((JavaUtilArrayList *) NIL_CHK(layers)) addWithId:layer];
      }
    }
    self.frames = frames;
    _framesPerMs_ = ((TripleplayFlumpLibrary *) NIL_CHK(lib)).frameRate / 1000;
    self.duration = frames / _framesPerMs_;
  }
  return self;
}

- (NSString *)name {
  return _name_;
}

- (TripleplayFlumpMovie *)createInstance {
  return [[[TripleplayFlumpMovie alloc] initWithTripleplayFlumpMovie_Symbol:self] autorelease];
}

- (void)dealloc {
  JreOperatorRetainedAssign(&_name_, self, nil);
  JreOperatorRetainedAssign(&layers_, self, nil);
  [super dealloc];
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayFlumpMovie_Symbol *typedCopy = (TripleplayFlumpMovie_Symbol *) copy;
  typedCopy.frames = frames_;
  typedCopy.layers = layers_;
  typedCopy.duration = duration_;
  typedCopy._name = _name_;
  typedCopy._framesPerMs = _framesPerMs_;
}

@end
@implementation TripleplayFlumpMovie_LayerAnimator

- (TripleplayFlumpLayerData *)data {
  return data_;
}
- (void)setData:(TripleplayFlumpLayerData *)data {
  JreOperatorRetainedAssign(&data_, self, data);
}
@synthesize data = data_;
- (id<PlaynCoreLayer>)content {
  return content_;
}
- (void)setContent:(id<PlaynCoreLayer>)content {
  JreOperatorRetainedAssign(&content_, self, content);
}
@synthesize content = content_;
@synthesize keyframeIdx = keyframeIdx_;
@synthesize changedKeyframe = changedKeyframe_;
- (id<TripleplayFlumpInstance>)_current {
  return _current_;
}
- (void)set_current:(id<TripleplayFlumpInstance>)_current {
  JreOperatorRetainedAssign(&_current_, self, _current);
}
@synthesize _current = _current_;
- (IOSObjectArray *)_instances {
  return _instances_;
}
- (void)set_instances:(IOSObjectArray *)_instances {
  JreOperatorRetainedAssign(&_instances_, self, _instances);
}
@synthesize _instances = _instances_;

- (id)initWithTripleplayFlumpLayerData:(TripleplayFlumpLayerData *)data {
  if ((self = [super init])) {
    keyframeIdx_ = 0;
    changedKeyframe_ = NO;
    self.data = data;
    if (((TripleplayFlumpLayerData *) NIL_CHK(data))._multipleSymbols) {
      JreOperatorRetainedAssign(&_instances_, self, [[[IOSObjectArray alloc] initWithLength:[((id<JavaUtilList>) NIL_CHK(data.keyframes)) size] type:[IOSClass classWithProtocol:@protocol(TripleplayFlumpInstance)]] autorelease]);
      for (int ii = 0, ll = (int) [((IOSObjectArray *) NIL_CHK(_instances_)) count]; ii < ll; ++ii) {
        [((IOSObjectArray *) NIL_CHK(_instances_)) replaceObjectAtIndex:ii withObject:[((id<TripleplayFlumpSymbol>) [((TripleplayFlumpKeyframeData *) [((id<JavaUtilList>) NIL_CHK(data.keyframes)) getWithInt:ii]) symbol]) createInstance]];
      }
      JreOperatorRetainedAssign(&content_, self, [((id<PlaynCoreGraphics>) [PlaynCorePlayN graphics]) createGroupLayer]);
      [self setCurrentWithTripleplayFlumpInstance:((id<TripleplayFlumpInstance>) [((IOSObjectArray *) NIL_CHK(_instances_)) objectAtIndex:0])];
    }
    else if (((TripleplayFlumpLayerData *) NIL_CHK(data))._lastSymbol != nil) {
      JreOperatorRetainedAssign(&_current_, self, [((TripleplayFlumpLayerData *) NIL_CHK(data))._lastSymbol createInstance]);
      JreOperatorRetainedAssign(&content_, self, [((id<TripleplayFlumpInstance>) NIL_CHK(_current_)) layer]);
    }
    else {
      JreOperatorRetainedAssign(&content_, self, [((id<PlaynCoreGraphics>) [PlaynCorePlayN graphics]) createGroupLayer]);
    }
  }
  return self;
}

- (void)setFrameWithFloat:(float)frame
                withFloat:(float)dt {
  id<JavaUtilList> keyframes = ((TripleplayFlumpLayerData *) NIL_CHK(data_)).keyframes;
  int finalFrame = [((id<JavaUtilList>) NIL_CHK(keyframes)) size] - 1;
  while (keyframeIdx_ < finalFrame && ((TripleplayFlumpKeyframeData *) [((id<JavaUtilList>) NIL_CHK(keyframes)) getWithInt:keyframeIdx_ + 1]).index <= frame) {
    ++keyframeIdx_;
    changedKeyframe_ = YES;
  }
  if (changedKeyframe_ && _instances_ != nil) {
    [self setCurrentWithTripleplayFlumpInstance:((id<TripleplayFlumpInstance>) [((IOSObjectArray *) NIL_CHK(_instances_)) objectAtIndex:keyframeIdx_])];
    changedKeyframe_ = NO;
  }
  TripleplayFlumpKeyframeData *kf = ((TripleplayFlumpKeyframeData *) [((id<JavaUtilList>) NIL_CHK(keyframes)) getWithInt:keyframeIdx_]);
  BOOL visible = [((TripleplayFlumpKeyframeData *) NIL_CHK(kf)) symbol] != nil && ((TripleplayFlumpKeyframeData *) NIL_CHK(kf)).visible;
  (void) [((id<PlaynCoreLayer>) NIL_CHK(content_)) setVisibleWithBOOL:visible];
  if (!visible) {
    return;
  }
  float locX = [((id<PythagorasFIPoint>) NIL_CHK(kf.loc)) x];
  float locY = [((id<PythagorasFIPoint>) NIL_CHK(kf.loc)) y];
  float scaleX = [((id<PythagorasFIPoint>) NIL_CHK(kf.scale_)) x];
  float scaleY = [((id<PythagorasFIPoint>) NIL_CHK(kf.scale_)) y];
  float skewX = [((id<PythagorasFIPoint>) NIL_CHK(kf.skew)) x];
  float skewY = [((id<PythagorasFIPoint>) NIL_CHK(kf.skew)) y];
  float alpha = ((TripleplayFlumpKeyframeData *) NIL_CHK(kf)).alpha;
  if (((TripleplayFlumpKeyframeData *) NIL_CHK(kf)).tweened && keyframeIdx_ < finalFrame) {
    float interp = (frame - ((TripleplayFlumpKeyframeData *) NIL_CHK(kf)).index) / ((TripleplayFlumpKeyframeData *) NIL_CHK(kf)).duration;
    float ease = ((TripleplayFlumpKeyframeData *) NIL_CHK(kf)).ease;
    if (ease != 0) {
      float t;
      if (ease < 0) {
        float inv = 1 - interp;
        t = 1 - inv * inv;
        ease = -ease;
      }
      else {
        t = interp * interp;
      }
      interp = ease * t + (1 - ease) * interp;
    }
    TripleplayFlumpKeyframeData *nextKf = ((TripleplayFlumpKeyframeData *) [((id<JavaUtilList>) NIL_CHK(keyframes)) getWithInt:keyframeIdx_ + 1]);
    locX += ([((id<PythagorasFIPoint>) NIL_CHK(nextKf.loc)) x] - locX) * interp;
    locY += ([((id<PythagorasFIPoint>) NIL_CHK(nextKf.loc)) y] - locY) * interp;
    scaleX += ([((id<PythagorasFIPoint>) NIL_CHK(nextKf.scale_)) x] - scaleX) * interp;
    scaleY += ([((id<PythagorasFIPoint>) NIL_CHK(nextKf.scale_)) y] - scaleY) * interp;
    skewX += ([((id<PythagorasFIPoint>) NIL_CHK(nextKf.skew)) x] - skewX) * interp;
    skewY += ([((id<PythagorasFIPoint>) NIL_CHK(nextKf.skew)) y] - skewY) * interp;
    alpha += (((TripleplayFlumpKeyframeData *) NIL_CHK(nextKf)).alpha - alpha) * interp;
  }
  float sinX = [PythagorasFFloatMath sinWithFloat:skewX], cosX = [PythagorasFFloatMath cosWithFloat:skewX];
  float sinY = [PythagorasFFloatMath sinWithFloat:skewY], cosY = [PythagorasFFloatMath cosWithFloat:skewY];
  float m00 = cosY * scaleX;
  float m01 = sinY * scaleX;
  float m10 = -sinX * scaleY;
  float m11 = cosX * scaleY;
  (void) [((id<PythagorasFTransform>) [((id<PlaynCoreLayer>) NIL_CHK(content_)) transform]) setTransformWithFloat:m00 withFloat:m01 withFloat:m10 withFloat:m11 withFloat:locX withFloat:locY];
  (void) [((id<PlaynCoreLayer>) NIL_CHK(content_)) setOriginWithFloat:[((id<PythagorasFIPoint>) NIL_CHK(kf.pivot)) x] withFloat:[((id<PythagorasFIPoint>) NIL_CHK(kf.pivot)) y]];
  (void) [((id<PlaynCoreLayer>) NIL_CHK(content_)) setAlphaWithFloat:alpha];
  if (_current_ != nil) {
    [_current_ paintWithFloat:dt];
  }
}

- (void)setCurrentWithTripleplayFlumpInstance:(id<TripleplayFlumpInstance>)current {
  if (_current_ != current) {
    JreOperatorRetainedAssign(&_current_, self, current);
    id<PlaynCoreGroupLayer> group = (id<PlaynCoreGroupLayer>) content_;
    [((id<PlaynCoreGroupLayer>) NIL_CHK(group)) clear];
    [((id<PlaynCoreGroupLayer>) NIL_CHK(group)) addWithPlaynCoreLayer:[((id<TripleplayFlumpInstance>) NIL_CHK(current)) layer]];
  }
}

- (void)dealloc {
  JreOperatorRetainedAssign(&_instances_, self, nil);
  JreOperatorRetainedAssign(&_current_, self, nil);
  JreOperatorRetainedAssign(&content_, self, nil);
  JreOperatorRetainedAssign(&data_, self, nil);
  [super dealloc];
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayFlumpMovie_LayerAnimator *typedCopy = (TripleplayFlumpMovie_LayerAnimator *) copy;
  typedCopy.data = data_;
  typedCopy.content = content_;
  typedCopy.keyframeIdx = keyframeIdx_;
  typedCopy.changedKeyframe = changedKeyframe_;
  typedCopy._current = _current_;
  typedCopy._instances = _instances_;
}

@end
